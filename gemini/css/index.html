<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanzaPro | Educador Financiero & AI Assistant</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Estilo base para usar la fuente Inter en todo el cuerpo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Color de fondo ligero */
        }
        /* Estilo para el input range */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2563eb; /* blue-600 */
            cursor: pointer;
            box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.2);
            transition: background 0.15s ease-in-out;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.2);
        }

        /* Animaciones del Chat */
        .chat-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen text-gray-800 pb-12 relative">

    <!-- Iconos SVG Inline (Base, se inyectar√°n despu√©s) -->
    <div id="svg-icons" class="hidden">
        <svg id="info-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block ml-1 text-gray-400 cursor-help"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
        <svg id="trending-up-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
        <svg id="shield-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
        <svg id="robot-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></svg>
        <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        <svg id="close-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-2 rounded-lg" id="header-icon-container">
                    <!-- Icono se inyectar√° aqu√≠ -->
                </div>
                <h1 class="text-xl font-bold text-gray-800">FinanzaPro <span class="font-normal text-gray-500">| Educador Financiero</span></h1>
            </div>
            <div class="text-sm text-gray-500 hidden sm:block">
                Simulaci√≥n en tiempo real
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- Columna Izquierda: Datos del Usuario (Input) -->
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden p-6">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span class="w-1 h-6 bg-blue-600 rounded-full block"></span>
                    Tus Datos Financieros
                </h2>

                <!-- Ingreso Mensual Neto -->
                <div id="income-slider"></div>

                <!-- Gastos Mensuales -->
                <div id="expenses-slider"></div>

                <!-- Capacidad de Ahorro Display -->
                <div class="p-4 bg-blue-50 rounded-lg mb-6 border border-blue-100">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-blue-800 font-medium">Capacidad de Ahorro</span>
                        <span class="text-lg font-bold text-blue-700" id="monthly-savings-display">$0</span>
                    </div>
                    <div class="w-full bg-blue-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" id="savings-rate-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Ahorros Actuales -->
                <div id="savings-slider"></div>

                <!-- Edad Actual y Retiro -->
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <div>
                        <label for="age-input" class="text-xs font-semibold text-gray-500 uppercase">Edad Actual</label>
                        <input type="number" id="age-input" value="30" min="18" max="99" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label for="retirement-age-input" class="text-xs font-semibold text-gray-500 uppercase">Edad Retiro</label>
                        <input type="number" id="retirement-age-input" value="65" min="18" max="99" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <!-- Mensaje de error amigable -->
                <div id="age-inconsistency-message" class="mt-2 text-xs text-red-500 bg-red-50 p-2 rounded hidden">
                    ‚ö†Ô∏è La edad actual es mayor o igual a la de retiro. La proyecci√≥n mostrar√° solo tu estado actual.
                </div>
            </div>

            <!-- Fondo de Emergencia Card -->
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 text-white border-none rounded-xl shadow-sm overflow-hidden p-6">
                <h3 class="font-bold text-lg mb-2 flex items-center gap-2" id="emergency-fund-header">
                    <!-- Icono se inyectar√° aqu√≠ -->
                    Fondo de Emergencia
                </h3>
                <div class="text-3xl font-bold mb-1">
                    <span id="emergency-months-display">0.0</span> <span class="text-base font-normal text-gray-400">meses</span>
                </div>
                <p class="text-sm text-gray-400 mb-4">
                    Basado en tus gastos de <span id="emergency-expenses-display">$0</span>.
                </p>

                <div class="text-xs px-3 py-2 bg-white/10 rounded-lg border border-white/10" id="emergency-status-message">
                    <!-- Mensaje de estado se inyectar√° aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Dashboard y Proyecciones (Output) -->
        <div class="lg:col-span-8 space-y-6">

            <!-- M√©tricas KPI -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Tasa de Ahorro KPI -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden p-4 border-l-4 border-l-blue-500">
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wide">Tasa de Ahorro</p>
                    <div class="text-2xl font-bold mt-1" id="savings-rate-display">0.0%</div>
                    <p class="text-xs text-gray-400 mt-2">Objetivo: &gt;20%</p>
                </div>

                <!-- Ratio Gastos/Ingresos KPI -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden p-4 border-l-4 border-l-orange-500">
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wide">Ratio Gastos/Ingresos</p>
                    <div class="text-2xl font-bold mt-1 text-gray-800" id="expense-ratio-display">0.0%</div>
                    <p class="text-xs text-gray-400 mt-2">Menor es mejor</p>
                </div>

                <!-- Proyecci√≥n Retiro KPI -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden p-4 border-l-4 border-l-green-500">
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wide">Proyecci√≥n Retiro</p>
                    <div class="text-2xl font-bold mt-1 text-gray-800" id="final-projection-display">$0.00M</div>
                    <p class="text-xs text-gray-400 mt-2">A los <span id="retirement-age-display-kpi">65</span> a√±os</p>
                </div>
            </div>

            <!-- Selector de Perfil y Gr√°ficos -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold">Perfil de Inversi√≥n</h2>
                    <div class="flex bg-gray-100 p-1 rounded-lg" id="risk-profile-selector">
                        <!-- Botones de perfil se inyectar√°n aqu√≠ -->
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <!-- Gr√°fico de Distribuci√≥n (Pastel) -->
                    <div class="flex flex-col items-center">
                        <div id="pie-chart-container" class="w-48 h-48 mx-auto relative">
                            <!-- Gr√°fico SVG se inyectar√° aqu√≠ -->
                        </div>
                        <div class="flex gap-4 mt-4" id="allocation-legend">
                            <!-- Leyenda se inyectar√° aqu√≠ -->
                        </div>
                    </div>

                    <!-- Descripci√≥n del Perfil -->
                    <div class="bg-gray-50 rounded-xl p-5 border border-gray-100" id="profile-description-card">
                        <h3 class="font-bold text-gray-800 mb-2 flex items-center" id="profile-name-rate">
                            <!-- Nombre y Tasa de Retorno -->
                        </h3>
                        <p class="text-sm text-gray-600 leading-relaxed mb-4" id="profile-description">
                            <!-- Descripci√≥n -->
                        </p>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Riesgo</span>
                                <div class="flex gap-1" id="risk-level-indicators">
                                    <!-- Indicadores de riesgo -->
                                </div>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Horizonte recomendado</span>
                                <span class="font-medium text-gray-700" id="horizonte-recomendado">
                                    <!-- Horizonte -->
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Proyecci√≥n -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden p-6">
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-1">Proyecci√≥n de Patrimonio</h2>
                    <p class="text-sm text-gray-500">
                        Crecimiento estimado basado en un ahorro mensual de <span id="projection-monthly-savings">$0</span> y el perfil <span id="projection-profile-name">Moderado</span>.
                    </p>
                </div>

                <div class="relative">
                    <div id="line-chart-container" class="w-full h-48">
                        <!-- Gr√°fico SVG se inyectar√° aqu√≠ -->
                    </div>
                </div>

                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-100 rounded-lg flex gap-3 items-start">
                    <span id="info-icon-projection"></span>
                    <p class="text-xs text-yellow-800 leading-relaxed">
                        <strong>Nota educativa:</strong> Este gr√°fico asume que reinviertes todos los rendimientos (inter√©s compuesto) y mantienes tu nivel de ahorro constante. La inflaci√≥n no est√° descontada para simplificar la visualizaci√≥n del crecimiento nominal.
                    </p>
                </div>
            </div>

        </div>
    </main>

    <!-- ==== ASISTENTE VIRTUAL IA ==== -->
    
    <!-- Bot√≥n flotante del Chat -->
    <div id="chat-button" class="fixed bottom-6 right-6 z-50 transition-transform hover:scale-105 cursor-pointer">
        <div class="bg-blue-600 text-white p-4 rounded-full shadow-lg flex items-center justify-center relative">
            <!-- Indicador de notificaci√≥n -->
            <span id="chat-notification" class="absolute top-0 right-0 -mt-1 -mr-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse hidden"></span>
            <div id="chat-icon-container"></div>
        </div>
    </div>

    <!-- Ventana del Chat -->
    <div id="chat-window" class="fixed bottom-24 right-6 w-80 md:w-96 h-[500px] bg-white rounded-2xl shadow-2xl z-50 flex flex-col hidden border border-gray-200 chat-enter">
        <!-- Chat Header -->
        <div class="bg-blue-600 text-white p-4 rounded-t-2xl flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                <div>
                    <h3 class="font-bold text-sm">Asistente IA</h3>
                    <p class="text-xs text-blue-100" id="ai-status">Inicializando Red Neuronal...</p>
                </div>
            </div>
            <button id="close-chat" class="text-white/80 hover:text-white">
                <!-- Icono cerrar -->
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
            <!-- Mensaje Bienvenida -->
            <div class="flex items-start gap-2.5">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs shrink-0">IA</div>
                <div class="flex flex-col gap-1 w-full max-w-[320px]">
                    <div class="flex items-center space-x-2 rtl:space-x-reverse">
                        <span class="text-xs font-semibold text-gray-900">Asistente Financiero</span>
                        <span class="text-xs font-normal text-gray-500">Ahora</span>
                    </div>
                    <div class="flex flex-col leading-1.5 p-4 border-gray-200 bg-white rounded-e-xl rounded-es-xl shadow-sm">
                        <p class="text-sm font-normal text-gray-900">Hola! Soy tu asistente personal entrenado con inteligencia artificial. Estoy analizando tu situaci√≥n financiera en tiempo real para darte las mejores recomendaciones.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Input Area -->
        <div class="p-3 bg-white border-t border-gray-100 rounded-b-2xl">
            <div class="flex gap-2">
                <button id="analyze-btn" class="flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-blue-200">
                    Analizar mi situaci√≥n actual
                </button>
            </div>
            <p class="text-[10px] text-gray-400 text-center mt-2">Powered by Neural Networks JS ‚Ä¢ v1.0</p>
        </div>
    </div>

    <script>
        // --- L√ìGICA DE LA RED NEURONAL (JAVASCRIPT PURO) ---

        /**
         * Clase SimpleNeuralNetwork
         * Implementa un Perceptr√≥n multicapa b√°sico.
         * Entradas (3): Tasa de Ahorro (0-1), Fondo Emergencia (0-12+), Ratio Gastos (0-1)
         * Salidas (3): [Cr√≠tico, Precauci√≥n, Saludable]
         */
        class SimpleNeuralNetwork {
            constructor() {
                // Pesos aleatorios iniciales
                this.weightsinputHidden = Array(3).fill().map(() => Array(4).fill(Math.random() - 0.5)); // 3 inputs -> 4 hidden
                this.weightsHiddenOutput = Array(4).fill().map(() => Array(3).fill(Math.random() - 0.5)); // 4 hidden -> 3 outputs
                this.biasHidden = Array(4).fill(Math.random() - 0.5);
                this.biasOutput = Array(3).fill(Math.random() - 0.5);
                this.learningRate = 0.1;
            }

            // Funci√≥n de activaci√≥n Sigmoide
            sigmoid(x) {
                return 1 / (1 + Math.exp(-x));
            }

            // Derivada de Sigmoide para backpropagation
            sigmoidDerivative(x) {
                return x * (1 - x);
            }

            // Feedforward: Calcula la salida basada en las entradas
            predict(inputs) {
                // Capa Oculta
                let hidden = [];
                for (let i = 0; i < 4; i++) {
                    let sum = 0;
                    for (let j = 0; j < 3; j++) {
                        sum += inputs[j] * this.weightsinputHidden[j][i];
                    }
                    hidden[i] = this.sigmoid(sum + this.biasHidden[i]);
                }

                // Capa de Salida
                let outputs = [];
                for (let i = 0; i < 3; i++) {
                    let sum = 0;
                    for (let j = 0; j < 4; j++) {
                        sum += hidden[j] * this.weightsHiddenOutput[j][i];
                    }
                    outputs[i] = this.sigmoid(sum + this.biasOutput[i]);
                }
                return outputs;
            }

            // Entrenamiento (Backpropagation)
            train(trainingData, iterations) {
                console.log(`üß† Iniciando entrenamiento de red neuronal (${iterations} iteraciones)...`);
                
                for (let iter = 0; iter < iterations; iter++) {
                    // Seleccionar un ejemplo aleatorio
                    let data = trainingData[Math.floor(Math.random() * trainingData.length)];
                    let inputs = data.inputs;
                    let targets = data.targets;

                    // --- Feedforward ---
                    // (Repetimos l√≥gica predict para tener acceso a valores intermedios 'hidden')
                    let hidden = [];
                    for (let i = 0; i < 4; i++) {
                        let sum = 0;
                        for (let j = 0; j < 3; j++) {
                            sum += inputs[j] * this.weightsinputHidden[j][i];
                        }
                        hidden[i] = this.sigmoid(sum + this.biasHidden[i]);
                    }

                    let outputs = [];
                    for (let i = 0; i < 3; i++) {
                        let sum = 0;
                        for (let j = 0; j < 4; j++) {
                            sum += hidden[j] * this.weightsHiddenOutput[j][i];
                        }
                        outputs[i] = this.sigmoid(sum + this.biasOutput[i]);
                    }

                    // --- Backpropagation ---
                    
                    // Error de salida
                    let outputErrors = [];
                    for (let i = 0; i < 3; i++) {
                        outputErrors[i] = targets[i] - outputs[i];
                    }

                    // Gradientes de salida
                    let outputGradients = [];
                    for (let i = 0; i < 3; i++) {
                        outputGradients[i] = outputErrors[i] * this.sigmoidDerivative(outputs[i]);
                    }

                    // Ajustar pesos Hidden -> Output
                    for (let i = 0; i < 4; i++) {
                        for (let j = 0; j < 3; j++) {
                            this.weightsHiddenOutput[i][j] += this.learningRate * outputGradients[j] * hidden[i];
                        }
                    }
                    // Ajustar bias Output
                    for(let i=0; i<3; i++) {
                         this.biasOutput[i] += this.learningRate * outputGradients[i];
                    }

                    // Error capa oculta
                    let hiddenErrors = [];
                    for (let i = 0; i < 4; i++) {
                        let error = 0;
                        for (let j = 0; j < 3; j++) {
                            error += outputErrors[j] * this.weightsHiddenOutput[i][j];
                        }
                        hiddenErrors[i] = error;
                    }

                    // Gradientes capa oculta
                    let hiddenGradients = [];
                    for (let i = 0; i < 4; i++) {
                        hiddenGradients[i] = hiddenErrors[i] * this.sigmoidDerivative(hidden[i]);
                    }

                    // Ajustar pesos Input -> Hidden
                    for (let i = 0; i < 3; i++) {
                        for (let j = 0; j < 4; j++) {
                            this.weightsinputHidden[i][j] += this.learningRate * hiddenGradients[j] * inputs[i];
                        }
                    }
                     // Ajustar bias Hidden
                     for(let i=0; i<4; i++) {
                         this.biasHidden[i] += this.learningRate * hiddenGradients[i];
                    }
                }
                console.log("‚úÖ Entrenamiento completado.");
            }
        }

        // --- DATOS DE ENTRENAMIENTO (LAS "BUENAS PR√ÅCTICAS") ---
        // Inputs: [TasaAhorro (0.0-1.0), MesesEmergencia (0-12 normalizado a 0-1 div 12), RatioGastos (0.0-1.0)]
        // Outputs: [Critico, Precaucion, Saludable]
        const trainingSet = [
            // Casos Malos (Criticos)
            { inputs: [0.05, 0.1, 0.95], targets: [1, 0, 0] }, // Ahorro bajo, casi sin fondo, gasto alto
            { inputs: [0.0, 0.0, 1.0], targets: [1, 0, 0] },   // Sin ahorro, sin fondo, todo gasto
            { inputs: [0.1, 0.2, 0.9], targets: [1, 0, 0] },
            
            // Casos Regulares (Precauci√≥n)
            { inputs: [0.15, 0.3, 0.85], targets: [0, 1, 0] }, // Ahorro medio bajo, fondo 3 meses
            { inputs: [0.20, 0.4, 0.80], targets: [0, 1, 0] },
            { inputs: [0.10, 0.5, 0.80], targets: [0, 1, 0] }, // Buen fondo pero bajo ahorro mensual
            
            // Casos Buenos (Saludables)
            { inputs: [0.30, 0.6, 0.70], targets: [0, 0, 1] }, // 30% ahorro, 6+ meses fondo
            { inputs: [0.50, 1.0, 0.50], targets: [0, 0, 1] }, // 50% ahorro, fondo lleno
            { inputs: [0.25, 0.8, 0.75], targets: [0, 0, 1] }
        ];

        // Instancia de la IA
        const financialAI = new SimpleNeuralNetwork();
        
        // --- VARIABLES DE ESTADO Y UI ---
        let state = {
            income: 25000,
            expenses: 15000,
            savings: 50000,
            age: 30,
            retirementAge: 65,
            riskProfile: 'moderado'
        };

        const PROFILES = {
            conservador: {
                name: "Conservador",
                fixed: 0.70,
                equity: 0.30,
                returnRate: 0.05, // 5%
                color: "#10b981",
                horizon: '< 3 a√±os',
                riskLevel: 1,
                desc: "Prioriza la seguridad del capital sobre el crecimiento. Ideal para plazos cortos o baja tolerancia al riesgo."
            },
            moderado: {
                name: "Moderado",
                fixed: 0.50,
                equity: 0.50,
                returnRate: 0.07, // 7%
                color: "#3b82f6",
                horizon: '3-7 a√±os',
                riskLevel: 2,
                desc: "Busca un equilibrio entre seguridad y crecimiento. La estrategia cl√°sica para el inversor promedio."
            },
            agresivo: {
                name: "Agresivo",
                fixed: 0.20,
                equity: 0.80,
                returnRate: 0.09, // 9%
                color: "#f59e0b",
                horizon: '> 7 a√±os',
                riskLevel: 3,
                desc: "Maximiza el crecimiento a largo plazo aceptando mayor volatilidad en el corto plazo."
            }
        };

        const $ = (id) => document.getElementById(id);

        // --- FUNCIONES DEL DOM Y L√ìGICA APP PRINCIPAL ---
        
        function createSlider(parentId, label, key, min, max, step, unit) {
            const parent = $(parentId);
            if (!parent) return;
            const initialValue = state[key];
            const html = `
                <div class="mb-4">
                    <div class="flex justify-between mb-1">
                        <label class="text-sm font-medium text-gray-700">${label}</label>
                        <span class="text-sm font-bold text-blue-600" id="${key}-value">${unit}${initialValue.toLocaleString()}</span>
                    </div>
                    <input type="range" min="${min}" max="${max}" value="${initialValue}" step="${step}" id="${key}-input" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"/>
                </div>
            `;
            parent.innerHTML = html;
            const input = $(`${key}-input`);
            const valueSpan = $(`${key}-value`);
            if (input && valueSpan) {
                input.oninput = (e) => {
                    let newValue = Number(e.target.value);
                    if (key === 'expenses') {
                        newValue = Math.min(newValue, state.income);
                        input.value = newValue;
                    }
                    state[key] = newValue;
                    valueSpan.textContent = `${unit}${newValue.toLocaleString()}`;
                    updateApp();
                };
            }
        }

        function renderPieChart(data, containerId) {
            const container = $(containerId);
            if (!container) return;
            container.innerHTML = '';
            if (data.length === 0) return;
            let cumulativePercent = 0;
            const getCoordinatesForPercent = (percent) => {
                const x = Math.cos(2 * Math.PI * percent);
                const y = Math.sin(2 * Math.PI * percent);
                return [x, y];
            };
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("viewBox", "-1 -1 2 2");
            svg.setAttribute("class", "transform -rotate-90 w-full h-full");
            data.forEach((slice) => {
                const start = cumulativePercent;
                cumulativePercent += slice.percent;
                const end = cumulativePercent;
                const [startX, startY] = getCoordinatesForPercent(start);
                const [endX, endY] = getCoordinatesForPercent(end);
                const largeArcFlag = slice.percent > 0.5 ? 1 : 0;
                const pathData = [`M 0 0`, `L ${startX} ${startY}`, `A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY}`, `Z`].join(' ');
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", pathData);
                path.setAttribute("fill", slice.color);
                path.setAttribute("class", "transition-all duration-300 hover:opacity-90");
                svg.appendChild(path);
            });
            container.appendChild(svg);
            const centerDiv = document.createElement('div');
            centerDiv.className = "absolute inset-0 m-auto w-24 h-24 bg-white rounded-full flex items-center justify-center flex-col shadow-inner";
            centerDiv.innerHTML = '<span class="text-xs text-gray-500 font-bold">Distribuci√≥n</span>';
            container.appendChild(centerDiv);
        }

        function renderLineChart(data, containerId, color) {
            const container = $(containerId);
            if (!container) return;
            container.innerHTML = '';
            if (!data || data.length === 0) return;
            const width = 100;
            const height = 50;
            const padding = 5;
            const maxVal = Math.max(...data.map(d => d.value));
            const minVal = 0; 
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
            svg.setAttribute("class", "w-full h-full overflow-visible");
            const points = data.map((d, i) => {
                const xProgress = data.length > 1 ? (i / (data.length - 1)) : 0.5;
                const x = padding + xProgress * (width - 2 * padding);
                const yProgress = maxVal > 0 ? ((d.value - minVal) / (maxVal - minVal)) : 0;
                const y = height - padding - yProgress * (height - 2 * padding);
                return `${x},${y}`;
            }).join(' ');
            const fillPath = data.length > 1 ? `${points} ${width - padding},${height - padding} ${padding},${height - padding}` : `${points} ${width/2},${height - padding}`; 
            svg.innerHTML += `<line x1="${padding}" y1="${height-padding}" x2="${width-padding}" y2="${height-padding}" stroke="#e5e7eb" stroke-width="0.5" />`;
            svg.innerHTML += `<line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height-padding}" stroke="#e5e7eb" stroke-width="0.5" />`;
            const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            polygon.setAttribute("points", fillPath);
            polygon.setAttribute("fill", color);
            polygon.setAttribute("fill-opacity", "0.1");
            svg.appendChild(polygon);
            const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            polyline.setAttribute("points", points);
            polyline.setAttribute("fill", "none");
            polyline.setAttribute("stroke", color);
            polyline.setAttribute("stroke-width", "1.5");
            polyline.setAttribute("stroke-linecap", "round");
            polyline.setAttribute("stroke-linejoin", "round");
            svg.appendChild(polyline);
            data.forEach((d, i) => {
                const xProgress = data.length > 1 ? (i / (data.length - 1)) : 0.5;
                const x = padding + xProgress * (width - 2 * padding);
                const yProgress = maxVal > 0 ? ((d.value - minVal) / (maxVal - minVal)) : 0;
                const y = height - padding - yProgress * (height - 2 * padding);
                const isSignificantPoint = data.length <= 10 || i % 5 === 0 || i === data.length - 1 || i === 0;
                if (isSignificantPoint) {
                    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    g.innerHTML += `<circle cx="${x}" cy="${y}" r="1.5" fill="white" stroke="${color}" stroke-width="1" />`;
                    g.innerHTML += `<text x="${x}" y="${y - 3}" font-size="3" text-anchor="middle" fill="#6b7280">${(d.value / 1000).toFixed(0)}k</text>`;
                    g.innerHTML += `<text x="${x}" y="${height}" font-size="3" text-anchor="middle" fill="#9ca3af">${d.year}</text>`;
                    svg.appendChild(g);
                }
            });
            container.appendChild(svg);
        }

        function updateApp() {
            const currentProfile = PROFILES[state.riskProfile];
            const currencyFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
            const decimalFormatter = new Intl.NumberFormat('es-MX', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
            const monthlySavings = state.income - state.expenses;
            const savingsRate = state.income > 0 ? (monthlySavings / state.income) * 100 : 0;
            const expenseRatio = state.income > 0 ? (state.expenses / state.income) * 100 : 0;
            const emergencyFundMonths = state.expenses > 0 ? state.savings / state.expenses : 0;
            const projectionData = [];
            let currentWealth = state.savings;
            const yearsToProject = Math.max(0, state.retirementAge - state.age); 
            const annualContribution = monthlySavings * 12;
            for (let i = 0; i <= yearsToProject; i++) {
                projectionData.push({ year: state.age + i, value: Math.round(currentWealth) });
                currentWealth = (currentWealth + annualContribution) * (1 + currentProfile.returnRate);
            }
            const finalProjectionValue = projectionData.length > 0 ? projectionData[projectionData.length - 1].value : 0;

            const expensesInput = $('expenses-input');
            const newMaxExpenses = state.income;
            if (expensesInput) {
                expensesInput.max = newMaxExpenses;
                if (state.expenses > newMaxExpenses) {
                    state.expenses = newMaxExpenses;
                    expensesInput.value = newMaxExpenses;
                    if($('expenses-value')) $('expenses-value').textContent = `$${newMaxExpenses.toLocaleString()}`;
                }
            }
            if($('monthly-savings-display')) $('monthly-savings-display').textContent = currencyFormatter.format(monthlySavings);
            if($('savings-rate-bar')) $('savings-rate-bar').style.width = `${Math.min(savingsRate, 100)}%`;
            if($('age-inconsistency-message')) {
                if (state.age >= state.retirementAge) $('age-inconsistency-message').classList.remove('hidden');
                else $('age-inconsistency-message').classList.add('hidden');
            }
            if($('retirement-age-display-kpi')) $('retirement-age-display-kpi').textContent = state.retirementAge;
            if($('emergency-months-display')) $('emergency-months-display').textContent = decimalFormatter.format(emergencyFundMonths);
            if($('emergency-expenses-display')) $('emergency-expenses-display').textContent = currencyFormatter.format(state.expenses);
            if($('emergency-status-message')) {
                if (emergencyFundMonths < 3) $('emergency-status-message').innerHTML = "‚ö†Ô∏è Cr√≠tico: Deber√≠as tener al menos 3 meses cubiertos.";
                else if (emergencyFundMonths >= 3 && emergencyFundMonths < 6) $('emergency-status-message').innerHTML = "‚ö†Ô∏è Bueno: Intenta llegar a 6 meses para mayor seguridad.";
                else $('emergency-status-message').innerHTML = "‚úÖ Excelente: Tienes una base s√≥lida.";
            }
            if ($('savings-rate-display')) {
                $('savings-rate-display').textContent = `${decimalFormatter.format(savingsRate)}%`;
                const getStatusColorClass = (val, type) => { if (type === 'savingsRate') return val >= 20 ? 'text-green-600' : val >= 10 ? 'text-yellow-600' : 'text-red-600'; return 'text-gray-700'; };
                $('savings-rate-display').className = `text-2xl font-bold mt-1 ${getStatusColorClass(savingsRate, 'savingsRate')}`;
            }
            if($('expense-ratio-display')) $('expense-ratio-display').textContent = `${decimalFormatter.format(expenseRatio)}%`;
            if($('final-projection-display')) $('final-projection-display').textContent = `$${(finalProjectionValue / 1000000).toFixed(2)}M`;
            renderPieChart([{ name: 'Renta Fija', percent: currentProfile.fixed, color: '#3b82f6' }, { name: 'Renta Variable', percent: currentProfile.equity, color: '#f59e0b' }], 'pie-chart-container');
            if($('allocation-legend')) $('allocation-legend').innerHTML = `<div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span><span class="text-sm font-medium">Renta Fija (${currentProfile.fixed * 100}%)</span></div><div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-orange-500"></span><span class="text-sm font-medium">Acciones (${currentProfile.equity * 100}%)</span></div>`;
            if($('profile-name-rate')) $('profile-name-rate').innerHTML = `Estrategia: ${currentProfile.name}<span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">Retorno est. ${currentProfile.returnRate * 100}%</span>`;
            if($('profile-description')) $('profile-description').textContent = currentProfile.desc;
            if($('risk-level-indicators')) $('risk-level-indicators').innerHTML = [1, 2, 3].map(i => `<div class="w-4 h-1.5 rounded-full ${(currentProfile.riskLevel >= i) ? 'bg-red-400' : 'bg-gray-200'}"></div>`).join('');
            if($('horizonte-recomendado')) $('horizonte-recomendado').textContent = currentProfile.horizon;
            renderLineChart(projectionData, 'line-chart-container', currentProfile.color);
            if($('projection-monthly-savings')) $('projection-monthly-savings').textContent = currencyFormatter.format(monthlySavings);
            if($('projection-profile-name')) $('projection-profile-name').textContent = currentProfile.name;
        }

        // --- FUNCIONES DEL CHATBOT ---

        function addChatMessage(text, sender = 'ai') {
            const container = $('chat-messages');
            if (!container) return;

            const isAI = sender === 'ai';
            const bgColor = isAI ? 'bg-white' : 'bg-blue-600';
            const textColor = isAI ? 'text-gray-900' : 'text-white';
            const align = isAI ? 'items-start' : 'items-end flex-row-reverse';
            const radius = isAI ? 'rounded-e-xl rounded-es-xl' : 'rounded-s-xl rounded-ee-xl';
            const avatar = isAI 
                ? `<div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs shrink-0">IA</div>`
                : `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-xs shrink-0">T√∫</div>`;

            const html = `
                <div class="flex ${align} gap-2.5">
                    ${avatar}
                    <div class="flex flex-col gap-1 w-full max-w-[320px]">
                        <div class="flex flex-col leading-1.5 p-4 border-gray-200 ${bgColor} ${radius} shadow-sm">
                            <p class="text-sm font-normal ${textColor}">${text}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Simular typing si es AI
            if(isAI && text !== "...") {
                // Remover indicador de escritura previo si existe
                const typing = document.getElementById('typing-indicator');
                if(typing) typing.remove();
            }

            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = $('chat-messages');
            const html = `
                <div id="typing-indicator" class="flex items-start gap-2.5">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs shrink-0">IA</div>
                    <div class="flex flex-col gap-1 w-full max-w-[100px]">
                        <div class="flex items-center p-4 bg-white rounded-e-xl rounded-es-xl shadow-sm h-10 gap-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }

        function getAIRecommendation() {
            // 1. Preparar Inputs Normalizados para la Red Neuronal
            // TasaAhorro (0 a 1), Esperamos > 0.2
            let savingsRate = state.income > 0 ? (state.income - state.expenses) / state.income : 0;
            // Fondo Emergencia (0 a 1), Normalizamos 12 meses como 1.0
            let emergencyFund = (state.expenses > 0 ? state.savings / state.expenses : 0) / 12;
            if(emergencyFund > 1) emergencyFund = 1;
            // Ratio Gastos (0 a 1)
            let expenseRatio = state.income > 0 ? state.expenses / state.income : 0;

            const inputs = [savingsRate, emergencyFund, expenseRatio];
            
            // 2. Predicci√≥n de la Red Neuronal
            const prediction = financialAI.predict(inputs);
            // prediction es [prob_critico, prob_precaucion, prob_saludable]

            // 3. Interpretar Salida
            const maxProbIndex = prediction.indexOf(Math.max(...prediction));
            
            let message = "";

            if (maxProbIndex === 0) { // Cr√≠tico
                message = "He analizado tus m√©tricas y mi red neuronal detecta una situaci√≥n **Cr√≠tica**. Tu tasa de ahorro es muy baja y tu exposici√≥n al riesgo es alta. \n\nüî¥ **Recomendaci√≥n:** Reduce gastos hormiga inmediatamente e intenta ahorrar al menos el 10% de tu ingreso. No inviertas en activos de riesgo hasta tener un fondo de emergencia.";
            } else if (maxProbIndex === 1) { // Precauci√≥n
                message = "Mi an√°lisis indica una situaci√≥n de **Precauci√≥n**. Est√°s en el camino correcto, pero hay m√°rgenes de mejora. \n\nüü° **Recomendaci√≥n:** Tu fondo de emergencia a√∫n no es √≥ptimo. Intenta aumentar tu tasa de ahorro al 20% antes de pensar en inversiones agresivas.";
            } else { // Saludable
                message = "¬°Excelentes noticias! La red neuronal clasifica tu salud financiera como **Saludable**. \n\nüü¢ **Recomendaci√≥n:** Tienes bases s√≥lidas. Podr√≠as considerar cambiar a un perfil de inversi√≥n m√°s 'Agresivo' para maximizar el inter√©s compuesto a largo plazo, ya que tienes respaldo.";
            }

            // Agregar un detalle espec√≠fico basado en reglas heur√≠sticas para complementar a la IA
            if (state.age > 50 && state.riskProfile === 'agresivo') {
                message += "\n\n‚ö†Ô∏è **Nota Adicional:** Veo que tienes m√°s de 50 a√±os y un perfil agresivo. La IA sugiere reducir riesgo a medida que te acercas al retiro para proteger tu capital.";
            }

            return message;
        }


        // --- INICIALIZACI√ìN ---

        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar Iconos
            const trendIcon = $('trending-up-icon');
            const shieldIcon = $('shield-icon');
            const infoIcon = $('info-icon');
            const robotIcon = $('robot-icon');
            const sendIcon = $('send-icon');
            const closeIcon = $('close-icon');

            if($('header-icon-container') && trendIcon) $('header-icon-container').innerHTML = trendIcon.outerHTML;
            if($('emergency-fund-header') && shieldIcon) $('emergency-fund-header').prepend(shieldIcon.cloneNode(true));
            if($('info-icon-projection') && infoIcon) $('info-icon-projection').innerHTML = infoIcon.outerHTML;
            if($('chat-icon-container') && robotIcon) $('chat-icon-container').innerHTML = robotIcon.outerHTML;
            if($('close-chat') && closeIcon) $('close-chat').innerHTML = closeIcon.outerHTML;

            // Inicializar APP
            createSlider('income-slider', 'Ingreso Mensual Neto', 'income', 5000, 200000, 1000, '$');
            createSlider('expenses-slider', 'Gastos Mensuales', 'expenses', 2000, 200000, 500, '$');
            createSlider('savings-slider', 'Ahorros Actuales', 'savings', 0, 1000000, 5000, '$');

            if($('age-input')) $('age-input').onchange = (e) => { state.age = Number(e.target.value); updateApp(); };
            if($('retirement-age-input')) $('retirement-age-input').onchange = (e) => { state.retirementAge = Number(e.target.value); updateApp(); };

            const selector = $('risk-profile-selector');
            if (selector) {
                Object.keys(PROFILES).forEach(key => {
                    const profile = PROFILES[key];
                    const button = document.createElement('button');
                    button.textContent = profile.name;
                    button.className = `px-4 py-1.5 rounded-md text-sm font-medium transition-all`;
                    button.onclick = () => {
                        state.riskProfile = key;
                        selector.querySelectorAll('button').forEach(btn => 
                            btn.className = `px-4 py-1.5 rounded-md text-sm font-medium transition-all ${state.riskProfile === btn.dataset.key ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`
                        );
                        updateApp();
                    };
                    button.dataset.key = key;
                    selector.appendChild(button);
                });
                const initialButton = selector.querySelector(`button[data-key="${state.riskProfile}"]`);
                if(initialButton) initialButton.className = 'px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-white text-blue-600 shadow-sm';
            }

            updateApp();

            // --- ENTRENAMIENTO DE IA ---
            // Entrenar la red neuronal con 1000 iteraciones al cargar
            setTimeout(() => {
                financialAI.train(trainingSet, 1000);
                if($('ai-status')) $('ai-status').textContent = "Red Neuronal Entrenada y Lista";
                if($('chat-notification')) $('chat-notification').classList.remove('hidden');
            }, 1000);

            // --- EVENTOS DEL CHAT ---
            const chatBtn = $('chat-button');
            const chatWindow = $('chat-window');
            const closeChatBtn = $('close-chat');
            const analyzeBtn = $('analyze-btn');

            if(chatBtn && chatWindow) {
                chatBtn.onclick = () => {
                    chatWindow.classList.toggle('hidden');
                    if($('chat-notification')) $('chat-notification').classList.add('hidden');
                };
            }

            if(closeChatBtn && chatWindow) {
                closeChatBtn.onclick = () => {
                    chatWindow.classList.add('hidden');
                };
            }

            if(analyzeBtn) {
                analyzeBtn.onclick = () => {
                    addChatMessage("Analiza mi situaci√≥n actual, por favor.", 'user');
                    showTypingIndicator();
                    
                    // Simular peque√±o delay de "pensamiento"
                    setTimeout(() => {
                        const recommendation = getAIRecommendation();
                        addChatMessage(recommendation, 'ai');
                    }, 1500);
                };
            }
        });
    </script>
</body>
</html>